<div class="d-flex flex-column gap-2 dh-crit-user-config">
    <p class="notes"><i class="fas fa-info-circle"></i> Configure per-player overrides for critical effects. These settings take precedence over the default PC configurations. Click +Text, +FX, +Sound, or +Art to customize each aspect for a player.</p>

    <div class="crit-user-list">
        {{#each players}}
        <div class="crit-user-card">
            <div class="crit-user-header">
                <span class="crit-art-color-dot" style="background-color: {{this.color}};"></span>
                <span class="crit-user-name">{{this.name}}</span>
                <div class="crit-user-badges">
                    {{#if this.hasText}}<span class="crit-user-badge badge-text">Text</span>{{/if}}
                    {{#if this.hasFx}}<span class="crit-user-badge badge-fx">FX</span>{{/if}}
                    {{#if this.hasSound}}<span class="crit-user-badge badge-sound">Sound</span>{{/if}}
                    {{#if this.hasArt}}<span class="crit-user-badge badge-art">Art</span>{{/if}}
                </div>
                <button type="button" class="crit-user-preview-btn" data-user-id="{{this.id}}" title="Preview this player's effects">
                    <i class="fas fa-play"></i>
                </button>
            </div>

            <div class="crit-user-toggles">
                <button type="button" class="crit-user-toggle-btn" data-target="user-{{this.id}}-text">
                    <i class="fas fa-font"></i> Text
                </button>
                <button type="button" class="crit-user-toggle-btn" data-target="user-{{this.id}}-fx">
                    <i class="fas fa-bolt"></i> FX
                </button>
                <button type="button" class="crit-user-toggle-btn" data-target="user-{{this.id}}-sound">
                    <i class="fas fa-music"></i> Sound
                </button>
                <button type="button" class="crit-user-toggle-btn" data-target="user-{{this.id}}-art">
                    <i class="fas fa-palette"></i> Art
                </button>
            </div>

            {{!-- TEXT OVERRIDE SECTION --}}
            <div id="user-{{this.id}}-text" class="crit-user-section" style="display: none;">
                <input type="hidden" name="users.{{this.id}}.text._active" value="{{#if this.hasText}}true{{else}}false{{/if}}">
                <div class="section-header">
                    <h4><i class="fas fa-font"></i> Text Override</h4>
                    <button type="button" class="crit-user-clear-btn" data-clear="users.{{this.id}}.text" data-category="text">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <div class="form-group use-image-row">
                    <label><i class="fas fa-image"></i> Use Image/Video</label>
                    <div class="form-fields">
                        <label class="slide-toggle">
                            <input type="checkbox" name="users.{{this.id}}.text.useImage" {{#if this.textOverride.useImage}}checked{{/if}}>
                            <span class="slider"></span>
                        </label>
                        <span class="hint">Display an image or video instead of text.</span>
                    </div>
                </div>

                <div class="user-image-group" {{#unless this.textOverride.useImage}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>File Path</label>
                        <div class="form-fields">
                            <file-picker style="flex: 1;" type="imagevideo" name="users.{{this.id}}.text.imagePath" value="{{this.textOverride.imagePath}}"></file-picker>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Size</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.text.imageSize">
                                {{#each ../imageSizes as |label key|}}
                                <option value="{{key}}" {{#if (eq ../textOverride.imageSize key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="user-text-group" {{#if this.textOverride.useImage}}style="display:none"{{/if}}>
                    <div class="form-group">
                        <label>Text</label>
                        <div class="form-fields">
                            <input type="text" name="users.{{this.id}}.text.content" value="{{this.textOverride.content}}" placeholder="CRITICAL" maxlength="16">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Font</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.text.fontFamily">
                                {{#each ../fonts as |label key|}}
                                <option value="{{key}}" {{#if (eq ../textOverride.fontFamily key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Font Size</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.text.fontSize">
                                {{#each ../fontSizes as |label key|}}
                                <option value="{{key}}" {{#if (eq ../textOverride.fontSize key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Letter Spacing</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.text.letterSpacing">
                                {{#each ../letterSpacings as |label key|}}
                                <option value="{{key}}" {{#if (eq ../textOverride.letterSpacing key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Use Player Color</label>
                        <div class="form-fields">
                            <label class="slide-toggle">
                                <input type="checkbox" name="users.{{this.id}}.text.usePlayerColor" {{#if this.textOverride.usePlayerColor}}checked{{/if}}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group user-color-group" {{#if this.textOverride.usePlayerColor}}style="display:none"{{/if}}>
                        <label>Color</label>
                        <div class="form-fields">
                            <input type="color" name="users.{{this.id}}.text.color" value="{{this.textOverride.color}}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Background Color</label>
                        <div class="form-fields">
                            <input type="color" name="users.{{this.id}}.text.backgroundColor" value="{{this.textOverride.backgroundColor}}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fill Mode</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.text.fill">
                                {{#each ../fills as |label key|}}
                                <option value="{{key}}" {{#if (eq ../textOverride.fill key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- FX OVERRIDE SECTION --}}
            <div id="user-{{this.id}}-fx" class="crit-user-section" style="display: none;">
                <div class="section-header">
                    <h4><i class="fas fa-bolt"></i> FX Override</h4>
                    <button type="button" class="crit-user-clear-btn" data-clear="users.{{this.id}}.fx" data-category="fx">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <div class="form-group">
                    <label>Effect Type</label>
                    <div class="form-fields">
                        <select name="users.{{this.id}}.fx.type">
                            {{#each ../effects as |label key|}}
                            <option value="{{key}}" {{#if (eq ../fxOverride.type key)}}selected{{/if}}>{{label}}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>

                {{!-- All FX option groups rendered, shown/hidden via JS --}}
                <div class="fx-options-group" data-fx-type="shake" {{#unless (eq this.fxOverride.type "shake")}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Intensity</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.fx.options.shake_intensity">
                                <option value="mild" {{#if (eq this.fxOverride.options.intensity "mild")}}selected{{/if}}>Mild</option>
                                <option value="normal" {{#if (or (eq this.fxOverride.options.intensity "normal") (not this.fxOverride.options.intensity))}}selected{{/if}}>Normal</option>
                                <option value="extreme" {{#if (eq this.fxOverride.options.intensity "extreme")}}selected{{/if}}>Extreme</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Duration (ms)</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.shake_duration" value="{{this.fxOverride.options.duration}}" placeholder="500">
                        </div>
                    </div>
                </div>

                <div class="fx-options-group" data-fx-type="shatter" {{#unless (eq this.fxOverride.type "shatter")}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Shard Count</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.shatter_count" value="{{this.fxOverride.options.count}}" placeholder="200">
                        </div>
                    </div>
                </div>

                <div class="fx-options-group" data-fx-type="border" {{#unless (eq this.fxOverride.type "border")}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Border Thickness (px)</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.border_thickness" value="{{this.fxOverride.options.thickness}}" placeholder="20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <div class="form-fields">
                            <input type="color" name="users.{{this.id}}.fx.options.border_color" value="{{this.fxOverride.options.color}}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Duration (ms)</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.border_duration" value="{{this.fxOverride.options.duration}}" placeholder="3000">
                        </div>
                    </div>
                </div>

                <div class="fx-options-group" data-fx-type="pulsate" {{#unless (eq this.fxOverride.type "pulsate")}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Intensity (1-5)</label>
                        <div class="form-fields">
                            <input type="range" name="users.{{this.id}}.fx.options.pulsate_intensity" value="{{this.fxOverride.options.intensity}}" min="1" max="5" step="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Duration (ms)</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.pulsate_duration" value="{{this.fxOverride.options.duration}}" placeholder="1000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Iterations</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.pulsate_iterations" value="{{this.fxOverride.options.iterations}}" placeholder="5">
                        </div>
                    </div>
                </div>

                <div class="fx-options-group" data-fx-type="confetti" {{#unless (eq this.fxOverride.type "confetti")}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Intensity</label>
                        <div class="form-fields">
                            <select name="users.{{this.id}}.fx.options.confetti_intensity">
                                {{#each ../confettiIntensities as |label key|}}
                                <option value="{{key}}" {{#if (eq ../fxOverride.options.intensity key)}}selected{{/if}}>{{label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Duration (ms)</label>
                        <div class="form-fields">
                            <input type="number" name="users.{{this.id}}.fx.options.confetti_duration" value="{{this.fxOverride.options.duration}}" placeholder="3000">
                        </div>
                    </div>
                </div>
            </div>

            {{!-- SOUND OVERRIDE SECTION --}}
            <div id="user-{{this.id}}-sound" class="crit-user-section" style="display: none;">
                <div class="section-header">
                    <h4><i class="fas fa-music"></i> Sound Override</h4>
                    <button type="button" class="crit-user-clear-btn" data-clear="users.{{this.id}}.sound" data-category="sound">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <div class="form-group sound-enable-row">
                    <label><i class="fas fa-volume-up"></i> Enable Sound</label>
                    <div class="form-fields">
                        <label class="slide-toggle">
                            <input type="checkbox" name="users.{{this.id}}.sound.enabled" {{#if this.soundOverride.enabled}}checked{{/if}}>
                            <span class="slider"></span>
                        </label>
                        <span class="hint">Enable custom sound for this player.</span>
                    </div>
                </div>

                <div class="user-sound-path-group" {{#unless this.soundOverride.enabled}}style="display:none"{{/unless}}>
                    <div class="form-group">
                        <label>Sound Path</label>
                        <div class="form-fields">
                            <file-picker style="flex: 1;" type="audio" name="users.{{this.id}}.sound.soundPath" value="{{this.soundOverride.soundPath}}"></file-picker>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- ART OVERRIDE SECTION --}}
            <div id="user-{{this.id}}-art" class="crit-user-section" style="display: none;">
                <input type="hidden" name="users.{{this.id}}.art._active" value="{{#if this.hasArt}}true{{else}}false{{/if}}">
                <div class="section-header">
                    <h4><i class="fas fa-palette"></i> Art Override</h4>
                    <button type="button" class="crit-user-clear-btn" data-clear="users.{{this.id}}.art" data-category="art">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <div class="form-group">
                    <label>Image</label>
                    <div class="form-fields">
                        <file-picker style="flex: 1;" type="imagevideo" name="users.{{this.id}}.art.imagePath" value="{{this.artOverride.imagePath}}" placeholder="path/to/art.webp"></file-picker>
                    </div>
                </div>

                <div class="form-group">
                    <label>Horizontal</label>
                    <div class="form-fields">
                        <select name="users.{{this.id}}.art.position">
                            <option value="left-out" {{#if (eq this.artOverride.position "left-out")}}selected{{/if}}>Left - Out</option>
                            <option value="left" {{#if (eq this.artOverride.position "left")}}selected{{/if}}>Left</option>
                            <option value="middle" {{#if (eq this.artOverride.position "middle")}}selected{{/if}}>Middle</option>
                            <option value="right" {{#if (eq this.artOverride.position "right")}}selected{{/if}}>Right</option>
                            <option value="right-out" {{#if (eq this.artOverride.position "right-out")}}selected{{/if}}>Right - Out</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Vertical</label>
                    <div class="form-fields">
                        <select name="users.{{this.id}}.art.positionY">
                            <option value="top-out" {{#if (eq this.artOverride.positionY "top-out")}}selected{{/if}}>Top - Out</option>
                            <option value="top" {{#if (eq this.artOverride.positionY "top")}}selected{{/if}}>Top</option>
                            <option value="middle" {{#if (eq this.artOverride.positionY "middle")}}selected{{/if}}>Middle</option>
                            <option value="bottom" {{#if (eq this.artOverride.positionY "bottom")}}selected{{/if}}>Bottom</option>
                            <option value="bottom-out" {{#if (eq this.artOverride.positionY "bottom-out")}}selected{{/if}}>Bottom - Out</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Size</label>
                    <div class="form-fields">
                        <select name="users.{{this.id}}.art.artSize">
                            <option value="very-small" {{#if (eq this.artOverride.artSize "very-small")}}selected{{/if}}>Very Small</option>
                            <option value="small" {{#if (eq this.artOverride.artSize "small")}}selected{{/if}}>Small</option>
                            <option value="normal" {{#if (eq this.artOverride.artSize "normal")}}selected{{/if}}>Normal</option>
                            <option value="large" {{#if (eq this.artOverride.artSize "large")}}selected{{/if}}>Large</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>

    <div class="form-footer">
        <button type="submit">
            <i class="fas fa-save"></i> Save Changes
        </button>
    </div>
</div>